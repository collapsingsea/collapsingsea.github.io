<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Homework 5-2: 自动售货机设计解析</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            line-height: 1.8;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #28a745;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; margin-top: 40px;}
        h3 { font-size: 1.2em; border-bottom: 1px dashed #ccc; }
        pre {
            background-color: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            white-space: pre-wrap; /* 自动换行 */
            word-wrap: break-word; /* 强制换行 */
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
        .comment {
            color: #5c6370;
            font-style: normal; /* 注释字体改为非斜体 */
        }
        .keyword {
            color: #c678dd;
        }
        .number {
            color: #d19a66;
        }
        .string {
            color: #98c379;
        }
        .qa-block {
            background-color: #e6ffed;
            border-left: 5px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .question {
            font-weight: bold;
            color: #155724;
        }
        .answer {
            margin-top: 5px;
        }
        li {
            margin-bottom: 10px;
        }
        .summary-block {
            background-color: #e2e8f0;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Homework 5-2: 自动售货机设计全解析</h1>
        <p>本项目利用有限状态机（FSM）模拟一个简单的自动售货机。该售货机可以接收1元和2元硬币，商品售价为2元。用户可以投币、购买商品或退款。通过数码管实时显示当前投币金额和找零/出货状态。</p>

        <h2>代码及逐行注释</h2>
        <pre><code><span class="keyword">module</span> <span class="string">Homework5_2</span>(<span class="string">clock</span>, <span class="string">K</span>, <span class="string">Seg7</span>, <span class="string">sel</span>);
    <span class="comment">// 模块声明</span>
    <span class="keyword">input</span>  		        <span class="string">clock</span>;
    <span class="keyword">input</span>  		[<span class="number">4</span>:<span class="number">1</span>]<span class="string">K</span>;
    <span class="keyword">output</span> <span class="keyword">reg</span>  [<span class="number">7</span>:<span class="number">0</span>]<span class="string">Seg7</span>;
    <span class="keyword">output</span> <span class="keyword">reg</span>  [<span class="number">3</span>:<span class="number">0</span>]<span class="string">sel</span>;

    <span class="comment">// 内部信号定义</span>
    <span class="keyword">wire</span> 			[<span class="number">4</span>:<span class="number">1</span>]<span class="string">DIF</span>;
    <span class="keyword">reg</span>			[<span class="number">2</span>:<span class="number">0</span>]<span class="string">DIN</span>, <span class="string">N</span>, <span class="string">N1</span>, <span class="string">N4</span>; <span class="comment">// N1: 显示投入金额, N4: 显示找零或出货状态</span>
    <span class="keyword">parameter</span>	[<span class="number">2</span>:<span class="number">0</span>]<span class="string">S0</span>=<span class="number">3'b000</span>, <span class="string">S1</span>=<span class="number">3'b001</span>, <span class="string">S2</span>=<span class="number">3'b010</span>, <span class="string">S3</span>=<span class="number">3'b011</span>, <span class="string">S4</span>=<span class="number">3'b100</span>, <span class="string">S5</span>=<span class="number">3'b101</span>, <span class="string">S6</span>=<span class="number">3'b110</span>, <span class="string">S7</span>=<span class="number">3'b111</span>; <span class="comment">// 定义FSM状态，表示不同金额和动作</span>
    <span class="keyword">reg</span> 			[<span class="number">2</span>:<span class="number">0</span>]<span class="string">ps</span>, <span class="string">ns</span>;
    <span class="keyword">reg</span>         [<span class="number">25</span>:<span class="number">0</span>]<span class="string">Q</span>;
    <span class="keyword">wire</span>        [<span class="number">1</span>:<span class="number">0</span>]<span class="string">scan</span>;
<div class="summary-block"><b>总结：</b>此部分声明了<code>Homework5_2</code>模块及其I/O端口。内部定义了用于按键消抖的<code>DIF</code>信号，用于显示金额和状态的`N1`和`N4`寄存器，以及FSM所需的状态参数和状态寄存器（`ps`, `ns`）。</div>
    <span class="comment">// --- 按键消抖与解码 (与5-1相同) ---</span>
    <span class="keyword">Press</span>  <span class="string">P1</span>(<span class="string">clock</span>, <span class="string">K</span>[<span class="number">1</span>], <span class="string">DIF</span>[<span class="number">1</span>]);		
    <span class="keyword">Press</span>  <span class="string">P2</span>(<span class="string">clock</span>, <span class="string">K</span>[<span class="number">2</span>], <span class="string">DIF</span>[<span class="number">2</span>]);
    <span class="keyword">Press</span>  <span class="string">P3</span>(<span class="string">clock</span>, <span class="string">K</span>[<span class="number">3</span>], <span class="string">DIF</span>[<span class="number">3</span>]);
    <span class="keyword">Press</span>  <span class="string">P4</span>(<span class="string">clock</span>, <span class="string">K</span>[<span class="number">4</span>], <span class="string">DIF</span>[<span class="number">4</span>]);
    <span class="keyword">always</span>@(*) <span class="keyword">begin</span> ... <span class="keyword">endcase</span> <span class="keyword">end</span> 
<div class="summary-block"><b>总结：</b>这部分的功能与上一个项目完全相同，负责对物理按键进行消抖处理，并将按键操作（投1元、投2元、购买、退款）转换为统一的数字信号`DIN`，供状态机使用。</div>
    <span class="comment">// --- FSM 状态转移逻辑 ---</span>
    <span class="keyword">always</span>@(<span class="keyword">posedge</span> <span class="string">clock</span>) <span class="keyword">begin</span> <span class="string">if</span>(<span class="string">DIF</span>[<span class="number">1</span>]==<span class="number">1</span> || <span class="string">DIF</span>[<span class="number">2</span>]==<span class="number">1</span> || <span class="string">DIF</span>[<span class="number">3</span>]==<span class="number">1</span> || <span class="string">DIF</span>[<span class="number">4</span>]==<span class="number">1</span>) <span class="string">ps</span><=<span class="string">ns</span>; <span class="keyword">end</span>

    <span class="comment">// --- FSM 下一状态和输出逻辑 ---</span>
    <span class="keyword">always</span>@(*)
    <span class="keyword">begin</span>
        <span class="keyword">case</span>(<span class="string">ps</span>)
            <span class="string">S0</span>: <span class="keyword">begin</span> <span class="comment">// 初始状态，金额为0</span>
                  <span class="string">N1</span>=<span class="number">0</span>; <span class="string">N4</span>=<span class="number">0</span>;
                  <span class="keyword">if</span> (<span class="string">DIN</span>==<span class="number">1</span>) <span class="string">ns</span>=<span class="string">S1</span>;      <span class="comment">// 投1元，进入S1</span>
                  <span class="keyword">else if</span> (<span class="string">DIN</span>==<span class="number">2</span>) <span class="string">ns</span>=<span class="string">S2</span>; <span class="comment">// 投2元，进入S2</span>
                  <span class="keyword">else</span> <span class="string">ns</span>=<span class="string">S0</span>;             <span class="comment">// 其他按键无效，保持S0</span>
                <span class="keyword">end</span>
            <span class="string">S1</span>: <span class="keyword">begin</span> <span class="comment">// 金额为1元</span>
                  <span class="string">N1</span>=<span class="number">1</span>; <span class="string">N4</span>=<span class="number">0</span>;
                  <span class="keyword">if</span> (<span class="string">DIN</span>==<span class="number">1</span>) <span class="string">ns</span>=<span class="string">S2</span>;      <span class="comment">// 再投1元，总额2元，进入S2</span>
                  <span class="keyword">else if</span> (<span class="string">DIN</span>==<span class="number">2</span>) <span class="string">ns</span>=<span class="string">S4</span>; <span class="comment">// 再投2元，总额3元，进入S4（超额）</span>
                  <span class="keyword">else if</span> (<span class="string">DIN</span>==<span class="number">3</span>) <span class="string">ns</span>=<span class="string">S5</span>; <span class="comment">// 按购买键，钱不够，进入S5提示错误</span>
                  <span class="keyword">else</span> <span class="string">ns</span>=<span class="string">S6</span>;             <span class="comment">// 按退款键，进入S6退1元</span>
                <span class="keyword">end</span>
            <span class="string">S2</span>: <span class="keyword">begin</span> ... <span class="keyword">end</span>
            ...
            <span class="string">S7</span>: <span class="keyword">begin</span> ... <span class="keyword">end</span>	  
        <span class="keyword">endcase</span> 
    <span class="keyword">end</span> 
<div class="summary-block"><b>总结：</b>这部分是自动售货机的核心状态机逻辑。它通过多个状态（S0-S7）来追踪当前投入的金额。每个状态下，都会根据用户的按键输入（`DIN`）来决定下一步的操作，例如累加金额、执行购买、执行退款，并跳转到相应的下一状态。同时，它会更新`N1`和`N4`的值，以控制数码管显示正确的金额和状态信息。</div>
    <span class="comment">// --- 七段数码管驱动逻辑 ---</span>
    <span class="keyword">always</span>@(<span class="keyword">posedge</span> <span class="string">clock</span>) <span class="keyword">begin</span> <span class="string">Q</span> <= <span class="string">Q</span> + <span class="number">1</span>; <span class="keyword">end</span>
    <span class="keyword">assign</span> <span class="string">scan</span> = <span class="string">Q</span>[<span class="number">19</span>:<span class="number">18</span>];

    <span class="keyword">always</span>@(*) <span class="keyword">begin</span> <span class="comment">// 位选，只选第一和第四个数码管</span>
        <span class="keyword">case</span>(<span class="string">scan</span>)
            <span class="number">0</span>: <span class="string">sel</span> = <span class="number">4'b1110</span>; <span class="comment">// 选中第一位</span>
            <span class="number">3</span>: <span class="string">sel</span> = <span class="number">4'b0111</span>; <span class="comment">// 选中第四位</span>
            <span class="keyword">default</span>: <span class="string">sel</span> = <span class="number">4'b1111</span>; <span class="comment">// 其他时间不选，防止重影</span>
        <span class="keyword">endcase</span> 
    <span class="keyword">end</span>

    <span class="keyword">always</span>@(*) <span class="keyword">begin</span>	<span class="comment">// 数据选择</span>
        <span class="keyword">case</span>(<span class="string">scan</span>)
            <span class="number">0</span>: <span class="string">N</span> = <span class="string">N1</span>; <span class="comment">// 第一位显示投入金额</span>
            <span class="number">3</span>: <span class="string">N</span> = <span class="string">N4</span>; <span class="comment">// 第四位显示找零/出货状态</span>
            <span class="keyword">default</span>: <span class="string">N</span> = <span class="number">0</span>;
        <span class="keyword">endcase</span>
    <span class="keyword">end</span>

    <span class="keyword">always</span>@(*) <span class="keyword">begin</span> <span class="comment">// 段选译码</span>
        <span class="keyword">case</span>(<span class="string">N</span>)
            <span class="number">0</span> : <span class="string">Seg7</span> = <span class="number">8'b11000000</span>;
            <span class="number">1</span> : <span class="string">Seg7</span> = <span class="number">8'b11111001</span>;		
            <span class="number">2</span> : <span class="string">Seg7</span> = <span class="number">8'b10100100</span>;
            <span class="number">3</span> : <span class="string">Seg7</span> = <span class="number">8'b10001110</span>; <span class="comment">// 用 'E' (Error/Eject) 表示出货或找零</span>
            <span class="keyword">default</span>: <span class="string">Seg7</span> = <span class="number">8'b11111111</span>;
        <span class="keyword">endcase</span>
    <span class="keyword">end</span> 
<span class="keyword">endmodule</span>
<div class="summary-block"><b>总结：</b>这部分是数码管的显示驱动电路。它通过动态扫描的方式，分时点亮第一位和第四位数码管。第一位用于显示投入的金额（由`N1`控制），第四位用于显示找零或出货的状态（由`N4`控制）。通过快速切换，实现了同时显示两个不同信息的效果。</div></code></pre>

        <h2>面试问答回顾</h2>
        <div class="qa-block">
            <p class="question">老师：讲解一下你的自动售货机的状态机是如何工作的。</p>
            <p class="answer">学生：这个状态机主要根据当前投币总额来划分状态。S0是初始状态（0元）。投1元进入S1，再投1元进入S2（总额2元）。如果在S0直接投2元也会进入S2。在S2状态下，如果按购买键（DIN=3），就会进入S5，表示购买成功，此时数码管显示N1=0, N4=3（表示出货）。如果钱不够时按购买，或是在任何有钱的状态下按退款，都会进入相应的找零状态（如S6, S7），最后返回S0。</p>
        </div>
        <div class="qa-block">
            <p class="question">老师：在你的设计里，怎么表示“投入的金额”和“找零/出货”？</p>
            <p class="answer">学生：我用了两个寄存器，N1和N4。N1用来存储当前投入的有效金额，并显示在第一位七段数码管上。N4用来表示找零的金额或出货动作，显示在第四位数码管上。例如，在S3状态（投入3元），N1显示2（商品价格），N4显示1（应找零1元）。在S5状态（购买成功），N1显示0（金额清空），N4显示3（代表出货）。</p>
        </div>

        <h2>潜在面试追问</h2>
        <ul>
            <li>
                <p class="question">问：你的FSM设计中，多个状态（如S1, S2, S3）都有相似的`if-else if`逻辑来处理按键输入。这种设计有什么潜在的缺点？如何改进？</p>
                <p class="answer">答：缺点是代码冗余，可读性和可维护性较差。如果需要增加新的按键功能或修改逻辑，可能需要在多个地方进行修改，容易出错。改进方法是，可以将处理按键的逻辑和状态转换的逻辑分开。例如，可以先用一个`always`块根据当前状态和输入决定一个“动作”（如投币、购买、退款），再用另一个`always`块根据这个“动作”和当前状态来决定下一个状态和输出。这样可以使逻辑更清晰，代码更模块化。</p>
            </li>
            <li>
                <p class="question">问：在S2状态下，如果用户再投1元（进入S3），显示屏会显示找零1元。但如果此时用户不按购买，而是按了退款，会发生什么？你的代码是如何处理的？</p>
                <p class="answer">答：根据我的代码，在S3状态下，如果用户按了退款键（`else`分支，即`DIN`为4），状态机会跳转到S7。在S7状态，`N1`和`N4`会分别被赋值为0和2，表示退还2元。但实际上用户投了3元，这里存在一个逻辑缺陷。正确的处理应该是跳转到一个能退还3元的状态，或者将S7状态的输出逻辑修改为能够退还`N1+N4`的总金额。这是一个很好的问题，我的当前设计在这点上可以改进。</p>
            </li>
            <li>
                <p class="question">问：这个设计是Moore型状态机还是Mealy型状态机？为什么？</p>
                <p class="answer">答：这是一个典型的Moore型状态机。因为所有的输出（`N1`, `N4`等）都只在`case(ps)`块内根据当前状态`ps`来确定，与当前的输入`DIN`没有直接的组合逻辑关系。输入`DIN`只用来决定下一个状态`ns`。如果输出（例如找零金额）直接依赖于`DIN`，比如`if (DIN==4) output_change = N1`，那它就更接近Mealy型。</p>
            </li>
        </ul>
        
        <h2>相关基础知识</h2>
        <ul>
            <li>
                <p class="question">什么是时序逻辑和组合逻辑？请在你的代码中各举一个例子。</p>
                <p class="answer">答：组合逻辑的输出仅取决于当前的输入，不含存储元件，如`assign scan = Q[19:18]`或`always@(*)`块。时序逻辑的输出不仅取决于当前输入，还与电路过去的状态有关，包含存储元件（如触发器），通常由时钟信号驱动，如`always@(posedge clock)`块。</p>
            </li>
            <li>
                <p class="question">在FPGA设计中，什么是“竞争”和“冒险”？如何避免？</p>
                <p class="answer">答：竞争是由于信号通过不同延迟的路径到达同一点而产生的现象。冒险是由于竞争可能导致电路输出产生不希望的毛刺（短暂的错误信号）。在同步设计中，通过确保所有信号都在时钟边沿被采样，可以有效避免冒险对系统功能的影响。在组合逻辑设计中，可以通过增加冗余项（如卡诺图中的冗余圈）来消除逻辑冒险。</p>
            </li>
            <li>
                <p class="question">如何用Verilog实现一个分频器，比如将50MHz时钟分频为1Hz？</p>
                <p class="answer">答：可以通过一个计数器实现。要从50MHz得到1Hz，分频系数是50,000,000。对于一个占空比50%的方波，其周期为1秒，半周期为0.5秒。需要计数的时钟周期数是 50,000,000 * 0.5 = 25,000,000。所以，可以设计一个计数器，在每个时钟上升沿加1，当计到25,000,000时，将输出信号翻转，并把计数器清零。就像代码中`pulse`的实现方式一样（但5_1代码中的计数值有误，应为25,000,000）。</p>
            </li>
        </ul>
    </div>
</body>
</html>